  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create backend deployment package (zip)
        run: |
          cd backend
          # ensure .ebextensions, package.json and package-lock.json exist in backend
          zip -r ../pharmax-backend.zip . -x "node_modules/*" "*.zip" "*.log" ".git/*"

      - name: Configure AWS CLI for cleanup step
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set default.region eu-north-1

      - name: Clean up old deployment versions
        run: |
          # Delete old versions (keep latest 5) - keep your existing commands
          aws elasticbeanstalk describe-application-versions \
            --application-name nodejsapp \
            --query 'ApplicationVersions[5:].VersionLabel' \
            --output text | tr '\t' '\n' | while read version; do
              if [ ! -z "$version" ]; then
                echo "Deleting old version: $version"
                aws elasticbeanstalk delete-application-version \
                  --application-name nodejsapp \
                  --version-label "$version" \
                  --delete-source-bundle || true
              fi
            done

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v22
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          region: eu-north-1
          application_name: nodejsapp
          environment_name: nodejsapp-env
          version_label: backend-${{ github.run_number }}-${{ github.sha }}
          deployment_package: pharmax-backend.zip
          wait_for_deployment: true
          use_existing_version_if_available: true
